date: 2014-12-27 17:13:05
category: project 
tag: tech, python, javascript
slug: AudioToArtImage
title: AudioToArtImage工具

### 概述

这个项目是通过萌萌介绍给我的，算是第一个练手的小项目。

对方的需求是将一小段音频转成一个酷炫的图片，效果类似 [weavesilk.com](http://weavesilk.com/).

![1]({filename}/images/AudioToArtImage.png)

在同[教皇大神](http://lingyu.wang/)讨论了下技术实现之后果断决定揽下这个<del>坑爹项目</del>.

### 用户需求


主要为以下几点.

*	音频批处理功能
*	指定输入输出目录
*	圣诞前完成

第一眼看上去，这个需求比较简单，但是仔细一想，其实坑挺多。有一些潜在的需求其实是客户没有直接描述的。

1.	 操作简单
2.	 windows下运行
3.	 酷炫的效果

### 设计架构

考虑到时间的紧迫性以及技术熟练程度，采用的技术架构如下

1.	用户界面采用html+css+js，也就是传统的web前端界面。
2.	图像生成模块利用[weavesilk.com](http://weavesilk.com/)原生的代码，在原来的基础上做一些接口化的开发和调整。
3.	音频处理模块以及web后端采用python进行开发。
4.	前端使用浏览器打开，后端使用webpy搭建一个本地的httpserver。
5.	使用pyinstaller生成可执行程序来进行win下的兼容。

### 交互流程
1.	前端选定音频文件后，将音频文件POST到后端
2.	后端提取音频特征后，生成鼠标轨迹数据，并返回给前端。
3.	前端利用canvas绘制好图片，将图片数据再POST回后端。
4.	后端将图片写到指定目录。

### 音频处理模块
一开始设计的时候，希望是能兼容几种比较主流的音频(mp3,wav,wma)。

在深入了解了一下音频这块的技术后，果断决定只支持wav格式。

一方面是开发周期比较短，另外一方面是python这块没有比较好的库可以支持,
参考[声音的输入输出](http://sebug.net/paper/books/scipydoc/wave_pyaudio.html).

### 绘制图片
模拟鼠标轨迹来绘制图片这一块着实花了很大的心思来弄。

有两个比较坑的地方

1.	js的异步执行机制，你没有办法像同步模型下进行如下的操作。

	<pre><code>mouse.down(x, y)
	sleep(sec)
	mouse.move(x, y)
	sleep(sec)
	mouse.up(x,y)
	</code></pre>
	
	最后采取的方式是人工计算延迟
	
	<pre><code>setTimeout(sleepMove(poi), tot);
	tot += Number(time_delay);
	</code></pre>
	
2.	因为前端绘图是在一个canvas里面操作(别问我为啥不在多个canvas操作，weavesilk.com的代码改起来还是很花时间的。。)
	
	所以需要对canvas加一个**互斥锁**，防止两份音频生成的鼠标轨迹同时画在canvas上。
	
	最后采用的方法是在server端加锁，每一个音频上传的upload方法里**加锁**，每一张图片saver的时候**锁释放**。
	
	这样可以防止canvas重绘的情况发生
	
### 前端交互

文件上传使用的是[plupload](http://www.plupload.com/)插件

在设计**指定输入输出目录**这个功能时,chrome的沙盒机制使得我没法在前端获取用户上传文件的路径。

当时有2个备选方案

1.	用户直接编辑配置文件
2.	上传文件夹采取拖动的方式，指定输出文件夹的功能同后台实时交互，需要实现<code>ls,cd</code>这两个功能。

第一个方案不用说，交互太挫，肯定会被拍回来

第二个方案的工作量也不小，而且在前端展示目录树也是需要耗费不少精力的。

最后考虑到用户交互的简单性，我决定在用户生成图片时**弹出一个对话框**让用户填入输出目录。这样既能避免用户直接编辑配置文件的差体验，也降低了开发的工作量。

事实证明这样的效果还不错，客户看到这个实现还是比较满意的。

### 总结

这次做私活还是有不少收益的，技术深度可能没有太大的增加，但是技术广度确实得到了不少提升。

同时对js，css这块的也由之前的未入门到现在的刚入门。

同时也感叹，私活不好找啊。以后多扩展下这方面的资源，在以后自己出来创业之前通过私活积累足够的资金和技术广度。

	




 
